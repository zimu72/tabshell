#!/usr/bin/env node
/**
 * Property-based tests for build-linux.mjs script
 * 
 * Property 4: AppImage Wrapper Script Configuration
 * 
 * Validates: Requirements 4.2, 4.3, 4.4
 */

import fs from 'node:fs'
import path from 'node:path'
import * as url from 'url'

const __dirname = url.fileURLToPath(new URL('.', import.meta.url))
const projectRoot = path.resolve(__dirname, '..')

// Required startup parameters
const REQUIRED_PARAMS = [
    '--no-sandbox',
    '--disable-dev-shm-usage',
    '--disable-gpu'
]

let testsPassed = 0
let testsFailed = 0

function test(name, fn) {
    try {
        fn()
        console.log(`✓ ${name}`)
        testsPassed++
    } catch (e) {
        console.error(`✗ ${name}`)
        console.error(`  Error: ${e.message}`)
        testsFailed++
    }
}

function assert(condition, message) {
    if (!condition) {
        throw new Error(message)
    }
}

// Load build-linux.mjs
const buildLinuxPath = path.join(projectRoot, 'scripts/build-linux.mjs')
const buildLinuxContent = fs.readFileSync(buildLinuxPath, 'utf8')

console.log('=== Build Linux Script Tests ===\n')

// Property 4: AppImage Wrapper Script Configuration
// For any AppImage wrapper script generated by the build system, it SHALL:
// - Set LD_LIBRARY_PATH to include the script's directory
// - Set ELECTRON_DISABLE_SANDBOX=1 environment variable
// - Pass all three required startup parameters to the AppImage executable
// - Pass user-provided arguments via "$@"
console.log('Property 4: AppImage Wrapper Script Configuration')
console.log('Validates: Requirements 4.2, 4.3, 4.4\n')

test('build-linux.mjs exists', () => {
    assert(fs.existsSync(buildLinuxPath), 'build-linux.mjs not found')
})

// Test AppImage wrapper script content
console.log('\n--- AppImage Wrapper Script Tests ---\n')

test('AppImage wrapper sets LD_LIBRARY_PATH (Requirement 4.2)', () => {
    // Check for LD_LIBRARY_PATH in the wrapper script template
    assert(buildLinuxContent.includes('export LD_LIBRARY_PATH='), 
        'Missing LD_LIBRARY_PATH export in wrapper script')
})

test('AppImage wrapper sets ELECTRON_DISABLE_SANDBOX=1 (Requirement 4.3)', () => {
    assert(buildLinuxContent.includes('export ELECTRON_DISABLE_SANDBOX=1'), 
        'Missing ELECTRON_DISABLE_SANDBOX=1 in wrapper script')
})

test('AppImage wrapper contains --no-sandbox (Requirement 4.4)', () => {
    // Check in the wrapper script section (bundleLibfuse2ForAppImage function)
    const wrapperMatch = buildLinuxContent.match(/fs\.writeFileSync\(wrapperPath,[\s\S]*?`\)/)
    assert(wrapperMatch, 'Could not find wrapper script template')
    assert(wrapperMatch[0].includes('--no-sandbox'), 
        'Missing --no-sandbox in AppImage wrapper')
})

test('AppImage wrapper contains --disable-dev-shm-usage (Requirement 4.4)', () => {
    const wrapperMatch = buildLinuxContent.match(/fs\.writeFileSync\(wrapperPath,[\s\S]*?`\)/)
    assert(wrapperMatch, 'Could not find wrapper script template')
    assert(wrapperMatch[0].includes('--disable-dev-shm-usage'), 
        'Missing --disable-dev-shm-usage in AppImage wrapper')
})

test('AppImage wrapper contains --disable-gpu (Requirement 4.4)', () => {
    const wrapperMatch = buildLinuxContent.match(/fs\.writeFileSync\(wrapperPath,[\s\S]*?`\)/)
    assert(wrapperMatch, 'Could not find wrapper script template')
    assert(wrapperMatch[0].includes('--disable-gpu'), 
        'Missing --disable-gpu in AppImage wrapper')
})

test('AppImage wrapper passes user arguments via "$@"', () => {
    const wrapperMatch = buildLinuxContent.match(/fs\.writeFileSync\(wrapperPath,[\s\S]*?`\)/)
    assert(wrapperMatch, 'Could not find wrapper script template')
    assert(wrapperMatch[0].includes('"$@"'), 
        'Missing "$@" for passing user arguments in wrapper')
})

// Test afterPack launcher script content
console.log('\n--- afterPack Launcher Script Tests ---\n')

test('afterPack launcher sets ELECTRON_DISABLE_SANDBOX=1', () => {
    // Check in the afterPack section
    const afterPackMatch = buildLinuxContent.match(/afterPack:[\s\S]*?fs\.writeFileSync\(exePath,[\s\S]*?`\)/)
    assert(afterPackMatch, 'Could not find afterPack launcher script template')
    assert(afterPackMatch[0].includes('export ELECTRON_DISABLE_SANDBOX=1'), 
        'Missing ELECTRON_DISABLE_SANDBOX=1 in afterPack launcher')
})

test('afterPack launcher contains --no-sandbox', () => {
    const afterPackMatch = buildLinuxContent.match(/afterPack:[\s\S]*?fs\.writeFileSync\(exePath,[\s\S]*?`\)/)
    assert(afterPackMatch, 'Could not find afterPack launcher script template')
    assert(afterPackMatch[0].includes('--no-sandbox'), 
        'Missing --no-sandbox in afterPack launcher')
})

test('afterPack launcher contains --disable-dev-shm-usage', () => {
    const afterPackMatch = buildLinuxContent.match(/afterPack:[\s\S]*?fs\.writeFileSync\(exePath,[\s\S]*?`\)/)
    assert(afterPackMatch, 'Could not find afterPack launcher script template')
    assert(afterPackMatch[0].includes('--disable-dev-shm-usage'), 
        'Missing --disable-dev-shm-usage in afterPack launcher')
})

test('afterPack launcher contains --disable-gpu', () => {
    const afterPackMatch = buildLinuxContent.match(/afterPack:[\s\S]*?fs\.writeFileSync\(exePath,[\s\S]*?`\)/)
    assert(afterPackMatch, 'Could not find afterPack launcher script template')
    assert(afterPackMatch[0].includes('--disable-gpu'), 
        'Missing --disable-gpu in afterPack launcher')
})

test('afterPack launcher passes user arguments via "$@"', () => {
    const afterPackMatch = buildLinuxContent.match(/afterPack:[\s\S]*?fs\.writeFileSync\(exePath,[\s\S]*?`\)/)
    assert(afterPackMatch, 'Could not find afterPack launcher script template')
    assert(afterPackMatch[0].includes('"$@"'), 
        'Missing "$@" for passing user arguments in afterPack launcher')
})

// Test build targets
console.log('\n--- Build Targets Tests ---\n')

test('build targets include deb (Requirement 7.1)', () => {
    assert(buildLinuxContent.includes("'deb'"), 
        'Missing deb in build targets')
})

test('build targets include rpm (Requirement 7.2)', () => {
    assert(buildLinuxContent.includes("'rpm'"), 
        'Missing rpm in build targets')
})

test('build targets include AppImage (Requirement 7.3)', () => {
    assert(buildLinuxContent.includes("'AppImage'"), 
        'Missing AppImage in build targets')
})

test('linux build array contains all three formats', () => {
    const linuxMatch = buildLinuxContent.match(/linux:\s*\[([^\]]+)\]/)
    assert(linuxMatch, 'Could not find linux build array')
    const targets = linuxMatch[1]
    assert(targets.includes("'deb'") && targets.includes("'rpm'") && targets.includes("'AppImage'"),
        'linux array should contain deb, rpm, and AppImage')
})

console.log('')
console.log('=== Test Summary ===')
console.log(`Passed: ${testsPassed}`)
console.log(`Failed: ${testsFailed}`)
console.log('')

if (testsFailed > 0) {
    process.exit(1)
}
