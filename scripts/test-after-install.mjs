#!/usr/bin/env node
/**
 * Property-based tests for after-install.tpl script
 * 
 * Property 1: Launcher Configuration Contains Required Parameters
 * Property 5: After-Install Script Parameter Passthrough
 * 
 * Validates: Requirements 1.1-1.3, 5.2-5.5
 */

import fs from 'node:fs'
import path from 'node:path'
import * as url from 'url'

const __dirname = url.fileURLToPath(new URL('.', import.meta.url))
const projectRoot = path.resolve(__dirname, '..')

// Required startup parameters
const REQUIRED_PARAMS = [
    '--no-sandbox',
    '--disable-dev-shm-usage',
    '--disable-gpu'
]

let testsPassed = 0
let testsFailed = 0

function test(name, fn) {
    try {
        fn()
        console.log(`✓ ${name}`)
        testsPassed++
    } catch (e) {
        console.error(`✗ ${name}`)
        console.error(`  Error: ${e.message}`)
        testsFailed++
    }
}

function assert(condition, message) {
    if (!condition) {
        throw new Error(message)
    }
}

// Load after-install.tpl
const afterInstallPath = path.join(projectRoot, 'build/linux/after-install.tpl')
const afterInstallContent = fs.readFileSync(afterInstallPath, 'utf8')

console.log('=== After-Install Script Tests ===\n')

// Property 1: Launcher Configuration Contains Required Parameters
// For any launcher script or configuration file generated by the build system, 
// it SHALL contain all three required startup parameters.
console.log('Property 1: Launcher Configuration Contains Required Parameters')
console.log('Validates: Requirements 1.1, 1.2, 1.3, 5.2, 5.3, 5.4\n')

test('after-install.tpl exists', () => {
    assert(fs.existsSync(afterInstallPath), 'after-install.tpl not found')
})

test('after-install.tpl contains --no-sandbox (Requirement 5.2)', () => {
    assert(afterInstallContent.includes('--no-sandbox'), 
        'Missing --no-sandbox parameter')
})

test('after-install.tpl contains --disable-dev-shm-usage (Requirement 5.3)', () => {
    assert(afterInstallContent.includes('--disable-dev-shm-usage'), 
        'Missing --disable-dev-shm-usage parameter')
})

test('after-install.tpl contains --disable-gpu (Requirement 5.4)', () => {
    assert(afterInstallContent.includes('--disable-gpu'), 
        'Missing --disable-gpu parameter')
})

test('after-install.tpl contains all required parameters', () => {
    const missing = REQUIRED_PARAMS.filter(param => !afterInstallContent.includes(param))
    assert(missing.length === 0, `Missing parameters: ${missing.join(', ')}`)
})

console.log('')

// Property 5: After-Install Script Parameter Passthrough
// For any after-install launcher script, it SHALL pass all user-provided 
// command-line arguments to the application using "$@" or equivalent.
console.log('Property 5: After-Install Script Parameter Passthrough')
console.log('Validates: Requirements 5.5\n')

test('after-install.tpl passes user arguments via "$@" (Requirement 5.5)', () => {
    assert(afterInstallContent.includes('"$@"'), 
        'Missing "$@" for passing user arguments')
})

test('after-install.tpl uses exec for process replacement', () => {
    assert(afterInstallContent.includes('exec '), 
        'Missing exec command for process replacement')
})

test('after-install.tpl creates launcher at /usr/bin/${executable} (Requirement 5.1)', () => {
    assert(afterInstallContent.includes('/usr/bin/${executable}'), 
        'Missing /usr/bin/${executable} path')
})

test('after-install.tpl sets executable permission', () => {
    assert(afterInstallContent.includes('chmod +x'), 
        'Missing chmod +x command')
})

console.log('')

// Additional validation: Check script structure
console.log('Additional Validation: Script Structure\n')

test('after-install.tpl is a valid bash script', () => {
    assert(afterInstallContent.startsWith('#!/bin/bash'), 
        'Script should start with #!/bin/bash')
})

test('after-install.tpl creates a valid shell script', () => {
    // Check that the heredoc creates a proper shell script
    assert(afterInstallContent.includes('#!/bin/sh'), 
        'Generated launcher should be a shell script')
})

test('after-install.tpl references correct installation path', () => {
    assert(afterInstallContent.includes('/opt/${productFilename}/${executable}'), 
        'Missing correct installation path reference')
})

console.log('')
console.log('=== Test Summary ===')
console.log(`Passed: ${testsPassed}`)
console.log(`Failed: ${testsFailed}`)
console.log('')

if (testsFailed > 0) {
    process.exit(1)
}
